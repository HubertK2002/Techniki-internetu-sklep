{% for msg in app.flashes('error') %}
	<div class="alert alert-danger">{{ msg }}</div>
{% endfor %}
{% for msg in app.flashes('success') %}
	<div class="alert alert-success">{{ msg }}</div>
{% endfor %}
{% set locked = order.Status != 'new' %}

<div
	data-controller="order-address-guard"
>

	{# KROK 1: dostawa #}
	<div class="card mb-3">
		<div class="card-body">
			<h5 class="mb-3">1) Metoda dostawy</h5>
			{% if order.DeliveryMethod %}
				<div class="mb-2">Wybrano: <strong>{{ order.DeliveryMethod }}</strong></div>
			{% endif %}
			<form method="post" action="{{ locked ? '' : path('order_set_delivery', { id: order.id }) }}" class="d-flex gap-2 flex-wrap">
				<button
					class="btn {{ order.DeliveryMethod == 'courier' ? 'btn-primary' : 'btn-outline-primary' }}"
					name="delivery_method"
					value="courier"
					{{ locked ? 'disabled' }}
				>
					Kurier
				</button>

				<button
					class="btn {{ order.DeliveryMethod == 'pickup' ? 'btn-primary' : 'btn-outline-primary' }}"
					name="delivery_method"
					value="pickup"
					{{ locked ? 'disabled' }}
				>
					Odbiór osobisty
				</button>
			</form>
		</div>
	</div>

	{# KROK 2: dane dostawy zależne od metody #}
	{% if order.DeliveryMethod is not null %}
	<div class="card mb-3">
		<div class="card-body">
			<h5 class="mb-3">2) Dane dostawy</h5>

			{% if order.DeliveryMethod == 'courier' %}
				<form id="shipping-form" method="post" action="{{ path('order_set_shipping', { id: order.id }) }}" class="row g-2">
					<div class="col-12">
						<input data-order-address-guard-target="addressLine" id="address_line" class="form-control" name="address_line" placeholder="Ulica i numer" {{ locked ? 'disabled' }}
							value="{{ order.AddressLine|default('') }}">
					</div>
					<div class="col-4">
						<input data-order-address-guard-target="postalCode" id="postal_code" class="form-control" name="postal_code" placeholder="Kod pocztowy" {{ locked ? 'disabled' }}
							value="{{ order.PostalCode|default('') }}">
					</div>
					<div class="col-8">
						<input data-order-address-guard-target="city" id="city" class="form-control" name="city" placeholder="Miasto" {{ locked ? 'disabled' }}
							value="{{ order.City|default('') }}">
					</div>
					<div class="col-12">
						<button class="btn btn-primary" {{ locked ? 'disabled' }}>Zapisz adres</button>
					</div>
				</form>
			{% elseif order.DeliveryMethod == 'pickup' %}
				<div class="text-muted">Odbiór na miejscu — nie wymagamy adresu.</div>
			{% else %}
				<div class="text-muted">Najpierw wybierz metodę dostawy.</div>
			{% endif %}
		</div>
	</div>
	{% endif %}

	{# KROK 3: płatność #}
	{% if order.DeliveryMethod is not null %}
	<div class="card mb-3"
		data-controller="order-payment"
		data-order-payment-url-value="{{ path('order_set_payment', { id: order.id }) }}"
		data-order-payment-locked-value="{{ locked ? 'true' : 'false' }}"
	>
		<div class="card-body">
			<h5 class="mb-3">3) Metoda płatności</h5>

			<div class="d-flex gap-2 flex-wrap">
				<button
					type="button"
					data-order-payment-target="payu"
					data-action="order-payment#choose"
					data-method="payu"
					class="btn {{ order.PaymentMethod == 'payu' ? 'btn-primary' : 'btn-outline-primary' }}"
					{{ locked ? 'disabled' }}
				>PayU</button>

				<button
					type="button"
					data-order-payment-target="cod"
					data-action="order-payment#choose"
					data-method="cod"
					class="btn {{ order.PaymentMethod == 'cod' ? 'btn-primary' : 'btn-outline-primary' }}"
					{{ locked ? 'disabled' }}
				>Za pobraniem</button>
			</div>
		</div>
	</div>
	{% endif %}

	{# KROK 4: finalizacja #}
	<div class="text-end">
		{% if order.Status == 'new' %}
			<div class="text-end">
				<form data-order-address-guard-target="confirmForm" id="confirm-form" method="post" action="{{ path('order_confirm', { id: order.id }) }}">
					<button class="btn btn-success" type="submit">Złóż zamówienie</button>
				</form>
			</div>
		{% else %}
			<div class="alert alert-success mb-0">
				Zamówienie zostało złożone.
			</div>
		{% endif %}
	</div>

	<div class="modal fade" tabindex="-1" data-order-address-guard-target="modal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Niezapisany adres</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
				</div>

				<div class="modal-body">
					<p class="mb-0">
						Zmieniłeś adres dostawy, ale nie kliknąłeś <strong>Zapisz adres</strong>.
						Czy chcesz złożyć zamówienie <strong>bez zapisania zmian</strong>?
					</p>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
						Wróć i zapisz
					</button>

					<button type="button" class="btn btn-primary" data-order-address-guard-target="continueButton">
						Kontynuuj
					</button>
				</div>
			</div>
		</div>
	</div>
</div>


